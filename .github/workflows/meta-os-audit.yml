name: Meta-OS Audit (A3 Scans + Air Lock)

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - 'rick/**'

jobs:
  meta-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Create reports directory
        run: mkdir -p reports
      
      # A3 Scan 1: Prisma paths scan
      - name: A3 Scan - Prisma usage paths
        run: |
          echo "Scanning for Prisma usage patterns..."
          grep -r "prisma\." src/ --include="*.ts" --include="*.js" -n > reports/evidence_prisma_paths.txt 2>&1 || true
          MATCH_COUNT=$(wc -l < reports/evidence_prisma_paths.txt 2>/dev/null || echo 0)
          echo '{"scan":"prisma_paths","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","matches":'${MATCH_COUNT}'}' > reports/evidence_prisma_paths.json
        continue-on-error: true
      
      # A3 Scan 2: Validator uniqueness scan
      - name: A3 Scan - Validator uniqueness
        run: |
          echo "Scanning for validator usage..."
          grep -r "validate" src/ --include="*.ts" --include="*.js" -n > reports/evidence_validator_uniqueness.txt 2>&1 || true
          MATCH_COUNT=$(wc -l < reports/evidence_validator_uniqueness.txt 2>/dev/null || echo 0)
          echo '{"scan":"validator_uniqueness","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","matches":'${MATCH_COUNT}'}' > reports/evidence_validator_uniqueness.json
        continue-on-error: true
      
      # A3 Scan 3: Secrets scan
      - name: A3 Scan - Secrets detection
        run: |
          echo "Scanning for potential secrets..."
          grep -r -i "password\|secret\|api_key\|token" . --include="*.ts" --include="*.js" --exclude-dir=node_modules --exclude-dir=.git -n > reports/evidence_secrets_scan.txt 2>&1 || true
          MATCH_COUNT=$(wc -l < reports/evidence_secrets_scan.txt 2>/dev/null || echo 0)
          echo '{"scan":"secrets_detection","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","matches":'${MATCH_COUNT}'}' > reports/evidence_secrets_scan.json
        continue-on-error: true
      
      # Run validation and capture output
      - name: Run contract validation
        run: |
          npm run validate 2>&1 | tee reports/evidence_validate.log
          echo '{"task":"validate","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","exit_code":'$?'}' > reports/evidence_validate.json
        continue-on-error: true
      
      # Run unit tests and capture output
      - name: Run unit tests
        id: unit_tests
        run: |
          npm test 2>&1 | tee reports/evidence_tests.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Save unit tests exit code
        if: always()
        run: |
          TEST_EXIT="${{ steps.unit_tests.outputs.exit_code }}"
          echo '{"task":"unit_tests","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","exit_code":'${TEST_EXIT:-1}'}' > reports/evidence_tests.json
      
      # Run Air Lock integration test
      - name: Run Air Lock integration test
        id: airlock_test
        run: |
          npm run test:airlock > reports/evidence_airlock_runtime.log 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        env:
          ASPACE_AIR_LOCK_MODE: 'true'
        continue-on-error: true
      
      - name: Extract Air Lock test JSON evidence
        if: always()
        run: |
          # Extract JSON evidence from test output (between "ðŸ“‹ EVIDENCE OUTPUT" marker and end)
          if grep -q "ðŸ“‹ EVIDENCE OUTPUT" reports/evidence_airlock_runtime.log; then
            sed -n '/ðŸ“‹ EVIDENCE OUTPUT/,${/^{/,/^}$/p}' reports/evidence_airlock_runtime.log > reports/evidence_airlock_runtime.json
          fi
          # Add exit_code to the evidence JSON
          AIRLOCK_EXIT="${{ steps.airlock_test.outputs.exit_code }}"
          if [ -f reports/evidence_airlock_runtime.json ] && [ -s reports/evidence_airlock_runtime.json ]; then
            # Use jq to add exit_code field if available, otherwise create basic JSON
            if command -v jq &> /dev/null; then
              jq --arg code "${AIRLOCK_EXIT:-1}" '. + {exit_code: ($code | tonumber)}' reports/evidence_airlock_runtime.json > reports/evidence_airlock_runtime.json.tmp
              mv reports/evidence_airlock_runtime.json.tmp reports/evidence_airlock_runtime.json
            else
              echo '{"exit_code":'${AIRLOCK_EXIT:-1}'}' > reports/evidence_airlock_runtime.json
            fi
          else
            echo '{"error":"Failed to extract JSON evidence","exit_code":'${AIRLOCK_EXIT:-1}'}' > reports/evidence_airlock_runtime.json
          fi
      
      # Create evidence index
      - name: Create evidence index
        if: always()
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          cat > reports/evidence_index.json << EOF
          {
            "workflow": "meta-os-audit",
            "timestamp": "${TIMESTAMP}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "evidence_files": [
              "evidence_prisma_paths.json",
              "evidence_validator_uniqueness.json",
              "evidence_secrets_scan.json",
              "evidence_validate.json",
              "evidence_tests.json",
              "evidence_airlock_runtime.json"
            ],
            "logs": [
              "evidence_prisma_paths.txt",
              "evidence_validator_uniqueness.txt",
              "evidence_secrets_scan.txt",
              "evidence_validate.log",
              "evidence_tests.log",
              "evidence_airlock_runtime.log"
            ]
          }
          EOF
      
      # Upload all reports as artifacts (always, even on failure)
      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: meta-os-audit-reports
          path: reports/
          retention-days: 30
      
      # Final check: Fail if any critical test failed
      - name: Check critical tests status
        if: always()
        run: |
          echo "Checking test results..."
          TESTS_EXIT="${{ steps.unit_tests.outputs.exit_code }}"
          AIRLOCK_EXIT="${{ steps.airlock_test.outputs.exit_code }}"
          
          echo "Unit tests exit code: ${TESTS_EXIT:-unknown}"
          echo "Air Lock test exit code: ${AIRLOCK_EXIT:-unknown}"
          
          if [ "${TESTS_EXIT}" != "0" ] || [ "${AIRLOCK_EXIT}" != "0" ]; then
            echo "âŒ One or more critical tests failed"
            exit 1
          else
            echo "âœ… All critical tests passed"
            exit 0
          fi
