// This is your Prisma schema file
// A'Space OS V2 Phoenix - Contract-First Architecture
// Prisma is a projection layer, NOT the source of truth

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CONTRACT LEDGER (Source of Truth)
// All database writes flow through this table
// ============================================

model Contract {
  id            String   @id @default(cuid())
  contractId    String   @unique // e.g., "ORD-20250714-001", "PULSE-20250720-..."
  contractType  String   // "Order", "Pulse", "Decision", "Intent", "Uplink"
  rawJson       Json     // Complete JSON contract (using JSONB in PostgreSQL)
  status        String   // "ACCEPTED" or "REJECTED"
  validationLog String?  // Validation errors if REJECTED (kept as String for simplicity)
  integrityHash String   // SHA-256 hash for immutable ledger verification
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([contractId])
  @@index([contractType])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// PROJECTION TABLES (Read Models)
// These are derived from accepted contracts
// ============================================

model Order {
  id                String   @id @default(cuid())
  orderId           String   @unique // ORD-20250714-001
  schemaVersion     String
  createdAt         DateTime
  createdBy         String
  projectId         String
  cycleType         String   // "12WY", "SOB", "ADHOC"
  cycleWeek         Int
  rockTitle         String
  rockDoD           Json     // JSON array (definition_of_done)
  tactics           Json     // JSON array
  constraints       Json     // JSON array
  escalationRules   Json     // JSON array
  linkedDecisionId  String?
  notes             String?
  ingestedAt        DateTime @default(now())

  @@index([orderId])
  @@index([projectId])
  @@index([createdAt])
}

model Pulse {
  id                    String   @id @default(cuid())
  pulseId               String   @unique // PULSE-20250720-ASPACE-W01
  schemaVersion         String
  createdAt             DateTime
  createdBy             String
  projectId             String
  week                  Int
  signalLevel           String   // "green", "orange", "red"
  kpiTmiCurrent         Float
  kpiTmiTarget          Float
  kpiTvrScore           Float
  kpi12wyCompletionPct  Float
  domains               Json     // JSON object
  type4DecisionsNeeded  Json     // JSON array
  notes                 String?
  ingestedAt            DateTime @default(now())

  @@index([pulseId])
  @@index([projectId])
  @@index([week])
  @@index([signalLevel])
  @@index([createdAt])
}

model Decision {
  id                   String   @id @default(cuid())
  decisionId           String   @unique // DEC-20250714-001
  schemaVersion        String
  createdAt            DateTime
  createdBy            String
  linkedIntentId       String
  projectId            String?
  signalLevel          String   // "green", "orange", "red"
  gate                 String?  // "BETH", "RICK", "SINGULARITY", "OTHER"
  type4Question        String
  options              Json     // JSON array
  recommendation       String
  rationale            Json     // JSON array (10 lines max)
  deadline             DateTime
  a0Decision           Json?    // JSON object (nullable)
  ingestedAt           DateTime @default(now())

  @@index([decisionId])
  @@index([linkedIntentId])
  @@index([signalLevel])
  @@index([createdAt])
}

model Intent {
  id                   String   @id @default(cuid())
  intentId             String   @unique // INT-20250714-001
  schemaVersion        String
  createdAt            DateTime
  createdBy            String
  projectId            String?
  title                String
  intentText           String
  domainsTouched       Json     // JSON array
  expectedEnergyCost   String   // "low", "medium", "high"
  timeHorizon          String   // "now", "1w", "4w", "12WY", "1y", "3y", "10y"
  riskLevel            String   // "low", "medium", "high"
  constraints          Json     // JSON array
  successCriteria      Json     // JSON array
  needsType4Decision   Boolean
  attachments          Json?    // JSON array (nullable)
  notes                String?
  ingestedAt           DateTime @default(now())

  @@index([intentId])
  @@index([projectId])
  @@index([createdAt])
}

model Uplink {
  id               String   @id @default(cuid())
  uplinkId         String   @unique // UPLINK-20250721
  schemaVersion    String
  createdAt        DateTime
  createdBy        String
  week             Int?
  projectId        String?
  lines            Json     // JSON array (exactly 10 lines)
  linkedPulseIds   Json     // JSON array
  type4Required    Boolean
  ingestedAt       DateTime @default(now())

  @@index([uplinkId])
  @@index([week])
  @@index([createdAt])
}
